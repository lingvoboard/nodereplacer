//Получение списка DSL тэгов.
if (o.Colors === undefined)
{

	o.Colors = Object.create(null);
	
	o.Colors["aliceblue"] = '';
	o.Colors["antiquewhite"] = '';
	o.Colors["aquamarine"] = '';
	o.Colors["aqua"] = '';
	o.Colors["azure"] = '';
	o.Colors["beige"] = '';
	o.Colors["bisque"] = '';
	o.Colors["blanchedalmond"] = '';
	o.Colors["blueviolet"] = '';
	o.Colors["blue"] = '';
	o.Colors["brown"] = '';
	o.Colors["burlywood"] = '';
	o.Colors["cadetblue"] = '';
	o.Colors["chartreuse"] = '';
	o.Colors["chocolate"] = '';
	o.Colors["coral"] = '';
	o.Colors["cornflower"] = '';
	o.Colors["cornsilk"] = '';
	o.Colors["crimson"] = '';
	o.Colors["cyan"] = '';
	o.Colors["darkblue"] = '';
	o.Colors["darkcyan"] = '';
	o.Colors["darkgoldenrod"] = '';
	o.Colors["darkgray"] = '';
	o.Colors["darkgreen"] = '';
	o.Colors["darkkhaki"] = '';
	o.Colors["darkmagenta"] = '';
	o.Colors["darkolivegreen"] = '';
	o.Colors["darkorange"] = '';
	o.Colors["darkorchid"] = '';
	o.Colors["darkred"] = '';
	o.Colors["darksalmon"] = '';
	o.Colors["darkseagreen"] = '';
	o.Colors["darkslateblue"] = '';
	o.Colors["darkslategray"] = '';
	o.Colors["darkturquoise"] = '';
	o.Colors["darkviolet"] = '';
	o.Colors["deeppink"] = '';
	o.Colors["deepskyblue"] = '';
	o.Colors["dimgray"] = '';
	o.Colors["dodgerblue"] = '';
	o.Colors["firebrick"] = '';
	o.Colors["floralwhite"] = '';
	o.Colors["forestgreen"] = '';
	o.Colors["fuchsia"] = '';
	o.Colors["gainsboro"] = '';
	o.Colors["ghostwhite"] = '';
	o.Colors["goldenrod"] = '';
	o.Colors["gold"] = '';
	o.Colors["gray"] = '';
	o.Colors["greenyellow"] = '';
	o.Colors["green"] = '';
	o.Colors["honeydew"] = '';
	o.Colors["hotpink"] = '';
	o.Colors["indianred"] = '';
	o.Colors["indigo"] = '';
	o.Colors["ivory"] = '';
	o.Colors["khaki"] = '';
	o.Colors["lavenderblush"] = '';
	o.Colors["lavender"] = '';
	o.Colors["lawngreen"] = '';
	o.Colors["lemonchiffon"] = '';
	o.Colors["lightblue"] = '';
	o.Colors["lightcoral"] = '';
	o.Colors["lightcyan"] = '';
	o.Colors["lightgoldenrodyellow"] = '';
	o.Colors["lightgray"] = '';
	o.Colors["lightgreen"] = '';
	o.Colors["lightpink"] = '';
	o.Colors["lightsalmon"] = '';
	o.Colors["lightseagreen"] = '';
	o.Colors["lightskyblue"] = '';
	o.Colors["lightslategray"] = '';
	o.Colors["lightsteelblue"] = '';
	o.Colors["lightyellow"] = '';
	o.Colors["limegreen"] = '';
	o.Colors["lime"] = '';
	o.Colors["linen"] = '';
	o.Colors["magenta"] = '';
	o.Colors["maroon"] = '';
	o.Colors["mediumaquamarine"] = '';
	o.Colors["mediumblue"] = '';
	o.Colors["mediumorchid"] = '';
	o.Colors["mediumpurple"] = '';
	o.Colors["mediumseagreen"] = '';
	o.Colors["mediumslateblue"] = '';
	o.Colors["mediumspringgreen"] = '';
	o.Colors["mediumturquoise"] = '';
	o.Colors["mediumvioletred"] = '';
	o.Colors["midnightblue"] = '';
	o.Colors["mintcream"] = '';
	o.Colors["mistyrose"] = '';
	o.Colors["moccasin"] = '';
	o.Colors["navajowhite"] = '';
	o.Colors["navy"] = '';
	o.Colors["oldlace"] = '';
	o.Colors["olivedrab"] = '';
	o.Colors["olive"] = '';
	o.Colors["orangered"] = '';
	o.Colors["orange"] = '';
	o.Colors["orchid"] = '';
	o.Colors["palegoldenrod"] = '';
	o.Colors["palegreen"] = '';
	o.Colors["paleturquoise"] = '';
	o.Colors["palevioletred"] = '';
	o.Colors["papayawhip"] = '';
	o.Colors["peachpuff"] = '';
	o.Colors["peru"] = '';
	o.Colors["pink"] = '';
	o.Colors["plum"] = '';
	o.Colors["powderblue"] = '';
	o.Colors["purple"] = '';
	o.Colors["red"] = '';
	o.Colors["rosybrown"] = '';
	o.Colors["royalblue"] = '';
	o.Colors["saddlebrown"] = '';
	o.Colors["salmon"] = '';
	o.Colors["sandybrown"] = '';
	o.Colors["seagreen"] = '';
	o.Colors["seashell"] = '';
	o.Colors["sienna"] = '';
	o.Colors["silver"] = '';
	o.Colors["skyblue"] = '';
	o.Colors["slateblue"] = '';
	o.Colors["slategray"] = '';
	o.Colors["snow"] = '';
	o.Colors["springgreen"] = '';
	o.Colors["steelblue"] = '';
	o.Colors["tan"] = '';
	o.Colors["teal"] = '';
	o.Colors["thistle"] = '';
	o.Colors["tomato"] = '';
	o.Colors["turquoise"] = '';
	o.Colors["violet"] = '';
	o.Colors["wheat"] = '';
	o.Colors["whitesmoke"] = '';
	o.Colors["white"] = '';
	o.Colors["yellowgreen"] = '';
	o.Colors["yellow"] = '';
	
	o.Languages = Object.create(null);
	
	o.Languages["Afrikaans"] = '';
	o.Languages["Arabic"] = '';
	o.Languages["ArmenianWestern"] = '';
	o.Languages["Armenian"] = '';
	o.Languages["AzeriLatin"] = '';
	o.Languages["Bashkir"] = '';
	o.Languages["Basque"] = '';
	o.Languages["Belarusian"] = '';
	o.Languages["Bulgarian"] = '';
	o.Languages["ChinesePRC"] = '';
	o.Languages["Chinese"] = '';
	o.Languages["Czech"] = '';
	o.Languages["Danish"] = '';
	o.Languages["Dutch"] = '';
	o.Languages["English"] = '';
	o.Languages["Estonian"] = '';
	o.Languages["Finnish"] = '';
	o.Languages["French"] = '';
	o.Languages["Georgian"] = '';
	o.Languages["GermanNewSpelling"] = '';
	o.Languages["German"] = '';
	o.Languages["Greek"] = '';
	o.Languages["Hungarian"] = '';
	o.Languages["Icelandic"] = '';
	o.Languages["Indonesian"] = '';
	o.Languages["Italian"] = '';
	o.Languages["Kazakh"] = '';
	o.Languages["Kirgiz"] = '';
	o.Languages["Latin"] = '';
	o.Languages["Latvian"] = '';
	o.Languages["Lithuanian"] = '';
	o.Languages["Malay"] = '';
	o.Languages["NorwegianBokmal"] = '';
	o.Languages["NorwegianNynorsk"] = '';
	o.Languages["Polish"] = '';
	o.Languages["PortugueseStandard"] = '';
	o.Languages["Romanian"] = '';
	o.Languages["Russian"] = '';
	o.Languages["SerbianCyrillic"] = '';
	o.Languages["Slovak"] = '';
	o.Languages["Slovenian"] = '';
	o.Languages["SpanishModernSort"] = '';
	o.Languages["SpanishTraditionalSort"] = '';
	o.Languages["Swahili"] = '';
	o.Languages["Swedish"] = '';
	o.Languages["Tajik"] = '';
	o.Languages["Tatar"] = '';
	o.Languages["Turkish"] = '';
	o.Languages["Turkmen"] = '';
	o.Languages["Ukrainian"] = '';
	o.Languages["UzbekLatin"] = '';
	
	o.LanId = Object.create(null);
	
	o.LanId["1025"] = '';
	o.LanId["1026"] = '';
	o.LanId["1028"] = '';
	o.LanId["1029"] = '';
	o.LanId["1030"] = '';
	o.LanId["1031"] = '';
	o.LanId["1032"] = '';
	o.LanId["1033"] = '';
	o.LanId["1034"] = '';
	o.LanId["1035"] = '';
	o.LanId["1036"] = '';
	o.LanId["1038"] = '';
	o.LanId["1039"] = '';
	o.LanId["1040"] = '';
	o.LanId["1043"] = '';
	o.LanId["1044"] = '';
	o.LanId["1045"] = '';
	o.LanId["1048"] = '';
	o.LanId["1049"] = '';
	o.LanId["1051"] = '';
	o.LanId["1053"] = '';
	o.LanId["1055"] = '';
	o.LanId["1057"] = '';
	o.LanId["1058"] = '';
	o.LanId["1059"] = '';
	o.LanId["1060"] = '';
	o.LanId["1061"] = '';
	o.LanId["1062"] = '';
	o.LanId["1063"] = '';
	o.LanId["1064"] = '';
	o.LanId["1067"] = '';
	o.LanId["1068"] = '';
	o.LanId["1069"] = '';
	o.LanId["1078"] = '';
	o.LanId["1079"] = '';
	o.LanId["1086"] = '';
	o.LanId["1087"] = '';
	o.LanId["1089"] = '';
	o.LanId["1090"] = '';
	o.LanId["1091"] = '';
	o.LanId["1092"] = '';
	o.LanId["1133"] = '';
	o.LanId["1142"] = '';
	o.LanId["1595"] = '';
	o.LanId["2052"] = '';
	o.LanId["2068"] = '';
	o.LanId["2070"] = '';
	o.LanId["3082"] = '';
	o.LanId["3098"] = '';
	o.LanId["32775"] = '';
	o.LanId["32811"] = '';
	
	//Old ID
	o.LanId["1"] = '';
	o.LanId["2"] = '';
	o.LanId["3"] = '';
	o.LanId["4"] = '';
	o.LanId["5"] = '';
	o.LanId["6"] = '';
	o.LanId["7"] = '';
	o.LanId["8"] = '';
	o.LanId["9"] = '';
	o.LanId["10"] = '';
	o.LanId["11"] = '';
	o.LanId["12"] = '';
	o.LanId["13"] = '';
	o.LanId["14"] = '';
	o.LanId["15"] = '';
	o.LanId["16"] = '';
	o.LanId["17"] = '';
	o.LanId["18"] = '';
	o.LanId["19"] = '';
	o.LanId["20"] = '';
	o.LanId["21"] = '';
	o.LanId["22"] = '';
	o.LanId["23"] = '';
	o.LanId["24"] = '';
	o.LanId["25"] = '';
	o.LanId["26"] = '';
	o.LanId["27"] = '';
	o.LanId["28"] = '';
	o.LanId["29"] = '';
	o.LanId["30"] = '';

	o.NormTags = Object.create(null);
	o.TagsWithErrors = Object.create(null);

	o.TagsInHeadwordsWithCB = Object.create(null);
	o.TagsInHeadwordsWithErrorsWithCB = Object.create(null);

	o.TagsInHeadwords = Object.create(null);
	o.TagsInHeadwordsWithErrors = Object.create(null);

}

function get_Tag_and_Check(s) {

	
	let m;
	let res = [false, "", 'Неизвестное имя тега'];


	if (/^\[((?:\/?(?:[\*'bcipumts]|com|ref|ex|url|trn1?|!trs|sub|sup|m))|(?:m\d+|\/lang|br))\]$/.test(s))
	{
			
		res[0] = true;
		res[1] = s.replace(/ .*$/, "").replace(/[\[\]\/\d]/g, "");
		res[2] = "";
	}
	else if (/^(?:<<|>>)$/.test(s))
	{
		res[0] = true;
		res[1] = "ref";
		res[2] = "";
	}
	else if (m = /^\[lang id=(.+)\]$/.exec(s))
	{

		if (o.LanId[m[1]] === undefined)
		{
			res[0] = true;
			res[1] = "lang";
			res[2] = 'Неподдерживаемый идентификатор языка';
		}
		else
		{
			res[0] = true;
			res[1] = "lang";
			res[2] = "";
		}

	}
	else if (m = /^\[lang name="(.+)"\]$/.exec(s))
	{



		if (o.Languages[m[1]] === undefined)
		{
			res[0] = true;
			res[1] = "lang";
			res[2] = 'Неподдерживаемый язык.';
		}
		else
		{
			res[0] = true;
			res[1] = "lang";
			res[2] = "";
		}

	}
	else if (/^\[lang name=""\]$/.test(s))
	{

		res[0] = true;
		res[1] = "lang";
		res[2] = 'Не задано значение параметра тега.';

	}
	else if (/^\[lang name=[^"].*[^"]\]$/.test(s))
	{

		res[0] = true;
		res[1] = "lang";
		res[2] = 'Имя языка без кавычек.';

	}
	else if (/^\[ref dict=[^"].*[^"]\]$/.test(s))
	{

		res[0] = true;
		res[1] = "ref";
		res[2] = 'Значение параметра dict должно быть заключено в кавычки.';


	}
	else if (m = /^\[ref dict="(.+)"\]$/.exec(s))
	{

		if (/^[^\x00-\x7F]+$/.test(m[1]))
		{
			res[0] = true;
			res[1] = "ref";
			res[2] = 'Имя словаря содержит символы, не входящие в набор ASCII.';
		}
		else
		{
			

			if (/^\[ref dict=".*".*"\]$/.test(s))
			{
		
				res[0] = true;
				res[1] = "ref";
				res[2] = 'Значение параметра dict содержит недопустимый символ.';
		
			}
			else
			{
				res[0] = true;
				res[1] = "ref";
				res[2] = "";
			}
			
		}

	}
	else if (/^\[ref dict=""\]$/.test(s))
	{

		res[0] = true;
		res[1] = "ref";
		res[2] = 'Не задано значение параметра тега.';

	}
	else if (m = /^\[c (.+)\]$/.exec(s))
	{

		if (o.Colors[m[1]] === undefined)
		{
			res[0] = true;
			res[1] = "c";
			res[2] = 'Неизвестное имя цвета.';
		}
		else
		{
			res[0] = true;
			res[1] = "c";
			res[2] = "";
		}

	}
	else if (s === '[lang]')
	{
		res[0] = true;
		res[1] = "lang";
		res[2] = 'Отсутствие значения у атрибута тега [lang].';

	}
	else
	{

	}
	
	
	return res;
}


s = o.utils.remove_comments(o.dsl[1]);


let m;
let re = /([^]*?)(\\*)(\[)/y;
let ind = 0;

while (m = re.exec(s))
{

	ind = re.lastIndex;

	if ((m[2].length % 2) === 1)
	{
		continue;
	}

	let tag;

	if (m[3] === '[')
	{


		let rs = s.substr(ind);

		let re2 = /([^]*?)(\\*)(\]|\[)/y;
		let m2 = re2.exec(rs);
		if ((m2) && (((m2[2].length % 2) === 0)) && (m2[3] === ']'))
		{


			re.lastIndex += re2.lastIndex;
			ind = re.lastIndex;
			tag = m[3] + m2[1] + m2[2] + m2[3];

		}
		else
		{
			
			continue;
			
		}


	}


	let res = get_Tag_and_Check(tag);

	if (!res[0])
	{
		continue;
	}


	if (res[2].length === 0)
	{
		o.NormTags[tag] = [res[1], ""];
	}
	else
	{
		o.TagsWithErrors[tag] = [res[1], res[2]];
	}


}


s = o.dsl[2].join("\n");

let re3 = /([^]*?)(\\*)(\{[^\{\}]*\})/y;

while (m = re3.exec(s))
{

	if ((m[2].length % 2) === 1)
	{
		continue;
	}

	let tag = m[3].replace(/^(\{\s*)/, "").replace(/(\s*\})$/, "");


	let res = get_Tag_and_Check(tag);

	if (!res[0])
	{
		continue;
	}


	if (res[2].length === 0)
	{
		o.TagsInHeadwords[m[3]] = [res[1], ""];
	}
	else
	{
		o.TagsInHeadwordsWithErrors[m[3]] = [res[1], res[2]];
	}

	
}

s = o.dsl[2].join("\n");
s = o.utils.remove_scb(s);
ind = 0;

while (m = re.exec(s))
{
	
	ind = re.lastIndex;

	if ((m[2].length % 2) === 1)
	{
		continue;
	}

	let tag;

	if (m[3] === '[')
	{


		let rs = s.substr(ind);

		let re2 = /([^]*?)(\\*)(\]|\[)/y;
		let m2 = re2.exec(rs);
		if ((m2) && (((m2[2].length % 2) === 0)) && (m2[3] === ']'))
		{


			re.lastIndex += re2.lastIndex;
			ind = re.lastIndex;
			tag = m[3] + m2[1] + m2[2] + m2[3];

		}
		else
		{
			
			continue;
			
		}


	}


	let res = get_Tag_and_Check(tag);

	if (!res[0])
	{
		continue;
	}


	if (res[2].length === 0)
	{
		o.TagsInHeadwords[tag] = [res[1], ""];
	}
	else
	{
		o.TagsInHeadwordsWithErrors[tag] = [res[1], res[2]];
	}


}



s = null;

function sortFunction(a, b) {
	if (a[0] === b[0]) {
		return (a[1] < b[1]) ? -1 : 1;
	}
	else {
		return (a[0] < b[0]) ? -1 : 1;
	}
}





function onexit()
{
	
	let arr1 = [];
	
	for (let key in o.NormTags)
	{
		arr1.push([o.NormTags[key][0], key, ""]);
	}

	arr1.sort(sortFunction);

	let arr2 = [];

	for (let key in o.TagsWithErrors)
	{
		arr2.push([o.TagsWithErrors[key][0], key, o.TagsWithErrors[key][1]]);
	}

	arr2.sort(sortFunction);
	
	o.res.push("\/\/ТЕГИ В КАРТОЧКАХ:\n");
	
	for (let v of arr1)
	{
		o.res.push(v[1]);
	}
	
	if (arr2.length > 0)
	o.res.push("\n\n\/\/Теги с ошибками:");


	for (let v of arr2)
	{
		o.res.push(v[1] + " - " + v[2]);
	}
	
	o.res.push("\n\n\/\/ТЕГИ В ЗАГОЛОВКАХ:\n");
	
	arr1.length = 0;

	for (let key in o.TagsInHeadwords)
	{
		arr1.push([o.TagsInHeadwords[key][0], key, ""]);
	}

	arr1.sort(sortFunction);

	arr2.length = 0;

	for (let key in o.TagsInHeadwordsWithErrors)
	{
		arr2.push([o.TagsInHeadwordsWithErrors[key][0], key, o.TagsInHeadwordsWithErrors[key][1]]);
	}

	arr2.sort(sortFunction);


	for (let v of arr1)
	{
		o.res.push(v[1]);
	}
	
	if (arr2.length > 0)
	o.res.push("\n\n\/\/Теги с ошибками:");


	for (let v of arr2)
	{
		o.res.push(v[1] + " - " + v[2]);
	}
	
	
}
